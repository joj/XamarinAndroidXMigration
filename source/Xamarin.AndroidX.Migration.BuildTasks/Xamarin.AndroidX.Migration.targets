<?xml version="1.0" encoding="utf-8"?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

    <UsingTask TaskName="Xamarin.AndroidX.Migration.BuildTasks.CecilfyFiles"
               AssemblyFile="$(MSBuildThisFileDirectory)Xamarin.AndroidX.Migration.BuildTasks.dll" />
    <UsingTask TaskName="Xamarin.AndroidX.Migration.BuildTasks.JetifyFiles"
               AssemblyFile="$(MSBuildThisFileDirectory)Xamarin.AndroidX.Migration.BuildTasks.dll" />

    <PropertyGroup>
        <_ShouldRunAndroidXTools Condition="'$(_ShouldRunAndroidXTools)' == '' and '$(AndroidApplication)' == 'true' and '$(IsUsingAndroidXLibraries)' == 'true'">true</_ShouldRunAndroidXTools>
        <_AndroidXIntermediateOutputPath>$(IntermediateOutputPath)androidx\</_AndroidXIntermediateOutputPath>
        <_AndroidXProguardIntermediateOutputPath>$(_AndroidXIntermediateOutputPath)proguard\</_AndroidXProguardIntermediateOutputPath>
        <_BeforeLinkAssemblies>
            $(_BeforeLinkAssemblies);
            _AndroidXCecilfy;
        </_BeforeLinkAssemblies>
        <AfterGenerateAndroidManifest>
            $(AfterGenerateAndroidManifest);
            _AndroidXJetifyManifest;
        </AfterGenerateAndroidManifest>
        <_AfterGenerateAndroidResourceDir>
            $(_AfterGenerateAndroidResourceDir);
            _AndroidXJetifyResources;
        </_AfterGenerateAndroidResourceDir>
        <_BeforeCompileDex>
            $(_BeforeCompileDex);
            _AndroidXJetifyProguardRules;
        </_BeforeCompileDex>
    </PropertyGroup>

    <!-- we want to ignore everything for the Android Support Java bits -->
    <ItemDefinitionGroup Condition="'$(_ShouldRunAndroidXTools)' == 'true'">
        <_AndroidXSupportAssembliesToSkip>
            <AndroidSkipResourceExtraction>true</AndroidSkipResourceExtraction>
            <AndroidSkipJavaStubGeneration>true</AndroidSkipJavaStubGeneration>
            <AndroidSkipAddToPackage>true</AndroidSkipAddToPackage>
            <AndroidSkipResourceProcessing>true</AndroidSkipResourceProcessing>
            <AndroidXSkipAndroidXMigration>true</AndroidXSkipAndroidXMigration>
        </_AndroidXSupportAssembliesToSkip>
        <_AndroidXAssembliesToSkip>
            <AndroidSkipResourceProcessing>true</AndroidSkipResourceProcessing>
            <AndroidXSkipAndroidXMigration>true</AndroidXSkipAndroidXMigration>
        </_AndroidXAssembliesToSkip>
    </ItemDefinitionGroup>

    <!-- add all the Android Support libraries to the items to ignore -->
    <ItemGroup Condition="'$(_ShouldRunAndroidXTools)' == 'true'">
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Arch.Core.Common" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Arch.Core.Runtime" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Arch.Lifecycle.Common" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Arch.Lifecycle.Extensions" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Arch.Lifecycle.LiveData" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Arch.Lifecycle.LiveData.Core" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Arch.Lifecycle.Runtime" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Arch.Lifecycle.ViewModel" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Arch.Persistence.Db" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Arch.Persistence.Db.Framework" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Arch.Persistence.Room.Common" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Arch.Persistence.Room.Runtime" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Arch.Work.Runtime" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.Animated.Vector.Drawable" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.Annotations" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.AsyncLayoutInflater" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.Collections" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.Compat" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.Constraint.Layout" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.Constraint.Layout.Solver" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.CoordinaterLayout" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.Core.UI" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.Core.Utils" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.CursorAdapter" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.CustomTabs" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.CustomView" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.Design" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.DocumentFile" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.DrawerLayout" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.Dynamic.Animation" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.Emoji" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.Emoji.AppCompat" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.Emoji.Bundled" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.Exif" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.Fragment" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.HeifWriter" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.Interpolator" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.Loader" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.LocalBroadcastManager" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.Media.Compat" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.Percent" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.Print" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.Recommendation" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.RecyclerView.Selection" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.Slices.Builders" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.Slices.Core" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.Slices.View" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.SlidingPaneLayout" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.SwipeRefreshLayout" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.TV.Provider" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.Transition" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.Vector.Drawable" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.VersionedParcelable" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.ViewPager" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.Wear" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.WebKit" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.v13" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.v17.Leanback" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.v17.Preference.Leanback" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.v4" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.v7.AppCompat" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.v7.CardView" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.v7.GridLayout" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.v7.MediaRouter" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.v7.Palette" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.v7.Preference" />
        <_AndroidXSupportAssembliesToSkip Include="Xamarin.Android.Support.v7.RecyclerView" />
    </ItemGroup>

    <!-- add all the AndroidX libraries to the items to ignore -->
    <ItemGroup Condition="'$(_ShouldRunAndroidXTools)' == 'true'">
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Annotation" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.AppCompat" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Arch.Core.Common" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Arch.Core.Runtime" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.AsyncLayoutInflater" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Browser" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.CardView" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Collection" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.ConstraintLayout" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.ConstraintLayout.Solver" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.CoordinatorLayout" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Core" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.CursorAdapter" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.CustomView" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.DocumentFile" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.DrawerLayout" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.DynamicAnimation" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Emoji" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Emoji.AppCompat" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Emoji.Bundled" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.ExifInterface" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Fragment" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.GridLayout" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.HeifWriter" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Interpolator" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Leanback" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Leanback.Preference" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Legacy.Support.Core.UI" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Legacy.Support.Core.Utils" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Legacy.Support.V4" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Legacy.Support.V13" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Lifecycle.Common" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Lifecycle.Extensions" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Lifecycle.LiveData" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Lifecycle.LiveData.Core" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Lifecycle.Process" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Lifecycle.Runtime" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Lifecycle.Service" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Lifecycle.ViewModel" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Loader" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.LocalBroadcastManager" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Media" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.MediaRouter" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Palette" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.PercentLayout" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Preference" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Print" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Recommendation" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.RecyclerView" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.RecyclerView.Selection" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Room.Common" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Room.Runtime" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Slice.Builders" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Slice.Core" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Slice.View" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.SlidingPaneLayout" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Sqlite" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Sqlite.Framework" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.SwipeRefreshLayout" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Transition" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.TvProvider" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.VectorDrawable" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.VectorDrawable.Animated" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.VersionedParcelable" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.ViewPager" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Wear" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.WebKit" />
        <_AndroidXAssembliesToSkip Include="Xamarin.AndroidX.Work.Runtime" />
        <_AndroidXAssembliesToSkip Include="Xamarin.Google.Android.Material" />
    </ItemGroup>

    <ItemGroup Condition="'$(_ShouldRunAndroidXTools)' == 'true'">
        <!-- let the build system append all the metadata to the assemblies -->
        <AndroidCustomMetaDataForReferences Include="@(_AndroidXSupportAssembliesToSkip)" />
        <AndroidCustomMetaDataForReferences Include="@(_AndroidXAssembliesToSkip)" />
    </ItemGroup>

    <Target Name="_FindCecilFiles"
        Condition="'$(_ShouldRunAndroidXTools)' == 'true'">
        <ItemGroup>
            <_FileToCecilfy Include="@(ResolvedUserAssemblies->'$(MonoAndroidLinkerInputDir)%(Filename)%(Extension)')"
                           Condition="'$(AndroidLinkMode)'=='None' and '%(ResolvedUserAssemblies.AndroidXSkipAndroidXMigration)' != 'true'" />
            <_FileToCecilfy Include="@(_ResolvedUserMonoAndroidAssemblies)"
                           Condition="'$(AndroidLinkMode)'!='None' and '%(ResolvedUserAssemblies.AndroidXSkipAndroidXMigration)' != 'true'" />
        </ItemGroup>
    </Target>

    <Target Name="_AndroidXCecilfy"
            DependsOnTargets="_FindCecilFiles"
            Inputs="@(_FileToCecilfy)"
            Outputs="$(_AndroidStampDirectory)_CopyIntermediateAssemblies.stamp"
            Condition="'$(_ShouldRunAndroidXTools)' == 'true'">

        <Message Text="Running Android X Cecilfy..." />

        <CecilfyFiles Assemblies="@(_FileToCecilfy)"
                     Verbose="true" />

        <Touch Files="$(_AndroidStampDirectory)_CopyIntermediateAssemblies.stamp" AlwaysCreate="True" />

        <Message Text="Android X Cecilfy complete." />

    </Target>

    <Target Name="_AndroidXJetifyManifest"
            Inputs="$(IntermediateOutputPath)android\AndroidManifest.xml"
            Outputs="$(_AndroidStampDirectory)_GenerateJavaStubs.stamp"
            Condition="'$(_ShouldRunAndroidXTools)' == 'true'">

        <Message Text="Jetifying: $(IntermediateOutputPath)android\AndroidManifest.xml" />

        <JetifyFiles Files="$(IntermediateOutputPath)android\AndroidManifest.xml"
                     Verbose="true" />
        
        <Touch Files="$(_AndroidStampDirectory)_GenerateJavaStubs.stamp" AlwaysCreate="True" />

        <Message Text="Android X Jetify on AndroidManifest.xml complete." />

    </Target>

    <Target Name="_FindJetifyFiles"
        Condition="'$(_ShouldRunAndroidXTools)' == 'true'">
        <ItemGroup>
            <!-- select all the app resources -->
            <_FilesToJetify Include="@(_AndroidResourceDest)"
                            Condition="'%(_AndroidResourceDest.Extension)' == '.xml'" />
            <!-- add the .jar files -->
            <_FilesToJetify Include="@(ExtractedJarImports)" />
        </ItemGroup>
    </Target>

    <Target Name="_AndroidXJetifyResources"
            Condition="'$(_ShouldRunAndroidXTools)' == 'true'"
            DependsOnTargets="_FindJetifyFiles"
            Inputs="@(_FilesToJetify)"
            Outputs="$(_AndroidResFlagFile);$(_AndroidStampDirectory)_ResolveLibraryProjectImports.stamp">

        <Message Text="Running Android X Jetify..." />

        <Message Text="Jetifying: @(_FilesToJetify)" />
        <JetifyFiles Files="@(_FilesToJetify)" Verbose="true" />
        <Touch Files="$(_AndroidResFlagFile);$(_AndroidStampDirectory)_ResolveLibraryProjectImports.stamp" AlwaysCreate="True" />

        <Message Text="Android X Jetify complete." />

    </Target>

    <Target Name="_AndroidXJetifyProguardRules"
            Condition="'$(_ShouldRunAndroidXTools)' == 'true'"
            Inputs="@(ProguardConfiguration)"
            Outputs="$(_AndroidStampDirectory)_AndroidXJetifyProguardRules.stamp">

        <Message Text="Running Android X Jetify on ProGuard files..." />

        <ItemGroup>
            <_ProguardsToJetify Include="@(ProguardConfiguration)" />
        </ItemGroup>

        <Message Text="Jetifying: @(_ProguardsToJetify)" />
        <RemoveDir Directories="$(_AndroidXProguardIntermediateOutputPath)" />
        <JetifyFiles Files="@(_ProguardsToJetify)"
                     JetifiedDirectory="$(_AndroidXProguardIntermediateOutputPath)"
                     IsProGuard="true"
                     Verbose="true" />
        <Touch Files="$(_AndroidStampDirectory)_AndroidXJetifyProguardRules.stamp" AlwaysCreate="True" />

        <ItemGroup>
            <ProguardConfiguration Remove="@(ProguardConfiguration)" />
            <ProguardConfiguration Include="$(_AndroidXProguardIntermediateOutputPath)*" />
            <FileWrites Include="@(ProguardConfiguration);$(_AndroidStampDirectory)_AndroidXJetifyProguardRules.stamp" />
        </ItemGroup>

        <Message Text="Android X Jetify on ProGuard files complete." />

    </Target>

</Project>
